version: '3.8'

services:
  mlflow-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mlflow-gateway
    ports:
      - "5000:5000"
    # Environment variables
    env_file:
      - .env
    # Volumes for persistent data and logs
    volumes:
      - mlflow-gateway-logs:/var/log/mlflow-gateway
      - ./config.yaml:/app/config.yaml:ro
    # Security
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /run
      - /var/run
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
    # Healthcheck configuration
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        compress: "true"
        labels: "mlflow-gateway"
    # Restart policy
    restart: unless-stopped
    # Network isolation
    networks:
      - mlflow-network

# Define volumes for persistent data
volumes:
  mlflow-gateway-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./logs

# Define networks for better isolation
networks:
  mlflow-network:
    driver: bridge
    internal: false

# Optional: Nginx reverse proxy for dev (uncomment to use)
#  nginx:
#    image: nginx:alpine
#    container_name: mlflow-gateway-nginx
#    ports:
#      - "80:80"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#    depends_on:
#      - mlflow-gateway
#    restart: unless-stopped
