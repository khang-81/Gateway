# Production Docker Compose Configuration
# Features:
# - Resource limits for scaling
# - Logging driver for request/cost tracking
# - Health checks
# - Support for Docker Swarm/Kubernetes scaling

services:
  mlflow-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mlflow-gateway-prod
    ports:
      - "5000:5000"
    # Don't mount config.yaml - entrypoint will create it dynamically
    env_file:
      - .env
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    restart: unless-stopped
    deploy:
      replicas: 2  # Scale to 2 instances
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        labels: "production,mlflow-gateway"
    # For Docker Swarm scaling:
    # deploy:
    #   replicas: 3
    #   update_config:
    #     parallelism: 1
    #     delay: 10s
    #   restart_policy:
    #     condition: on-failure

# For Docker Swarm secrets (production):
# secrets:
#   openai_api_key:
#     external: true

# For custom network:
# networks:
#   mlflow-network:
#     driver: overlay

