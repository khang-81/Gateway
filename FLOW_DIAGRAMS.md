# FLOW DIAGRAMS - MLFLOW AI GATEWAY

## ğŸ“Š Flow 1: Deploy vÃ  Má»Ÿ Rá»™ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DEPLOYMENT FLOW                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. CHUáº¨N Bá»Š
   â”‚
   â”œâ”€â–º Copy env.template â†’ .env
   â”œâ”€â–º ThÃªm OPENAI_API_KEY vÃ o .env
   â””â”€â–º Chmod +x *.sh
        â”‚
        â–¼
2. DEPLOY DEVELOPMENT
   â”‚
   â”œâ”€â–º docker compose up -d
   â”‚   â”‚
   â”‚   â”œâ”€â–º Build Docker image
   â”‚   â”œâ”€â–º Start container
   â”‚   â”œâ”€â–º Health check (40s)
   â”‚   â””â”€â–º Container running âœ…
   â”‚
   â””â”€â–º Verify: curl http://localhost:5000/health
        â”‚
        â–¼
3. SCALE PRODUCTION
   â”‚
   â”œâ”€â–º docker compose -f docker-compose.prod.yml up -d --scale mlflow-gateway=3
   â”‚   â”‚
   â”‚   â”œâ”€â–º Start 3 gateway instances
   â”‚   â”œâ”€â–º Start nginx load balancer
   â”‚   â”œâ”€â–º Health checks (all instances)
   â”‚   â””â”€â–º Load balancing active âœ…
   â”‚
   â””â”€â–º Verify: docker ps (3 instances + nginx)
        â”‚
        â–¼
4. MONITORING
   â”‚
   â”œâ”€â–º docker compose logs -f mlflow-gateway
   â”œâ”€â–º docker logs mlflow-gateway-nginx
   â””â”€â–º ./check_gateway.sh
```

### Architecture Diagram:

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Client    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Nginx Load Balancerâ”‚
              â”‚   (Port 5000)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚Gateway  â”‚  â”‚Gateway  â”‚  â”‚Gateway  â”‚
  â”‚Instance â”‚  â”‚Instance â”‚  â”‚Instance â”‚
  â”‚   1     â”‚  â”‚   2     â”‚  â”‚   3     â”‚
  â”‚(4 workers)â”‚(4 workers)â”‚(4 workers)â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚            â”‚            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  OpenAI API   â”‚
            â”‚  (External)   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Flow 2: ÄÃ¡nh GiÃ¡ API Gateway

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EVALUATION FLOW                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. PREPARATION
   â”‚
   â”œâ”€â–º Check gateway is running
   â”œâ”€â–º Verify API key is valid
   â””â”€â–º Check health endpoint
        â”‚
        â–¼
2. RUN EVALUATION
   â”‚
   â”œâ”€â–º python3 evaluate_gateway.py
   â”‚   â”‚
   â”‚   â”œâ”€â–º Health Check
   â”‚   â”‚   â””â”€â–º GET /health â†’ {"status": "OK"} âœ…
   â”‚   â”‚
   â”‚   â”œâ”€â–º Test 1: Simple Question
   â”‚   â”‚   â”œâ”€â–º POST /gateway/chat/invocations
   â”‚   â”‚   â”œâ”€â–º Request: {"messages": [{"role": "user", "content": "What is AI?"}]}
   â”‚   â”‚   â”œâ”€â–º Response: {choices, usage}
   â”‚   â”‚   â”œâ”€â–º Extract: prompt_tokens, completion_tokens
   â”‚   â”‚   â””â”€â–º Calculate: cost âœ…
   â”‚   â”‚
   â”‚   â””â”€â–º Test 2: Multi-turn Conversation
   â”‚       â”œâ”€â–º POST /gateway/chat/invocations
   â”‚       â”œâ”€â–º Request: Multi-turn messages
   â”‚       â”œâ”€â–º Response: {choices, usage}
   â”‚       â”œâ”€â–º Extract: tokens
   â”‚       â””â”€â–º Calculate: cost âœ…
   â”‚
   â””â”€â–º Save results to gateway_results.json
        â”‚
        â–¼
3. RESULTS
   â”‚
   â”œâ”€â–º Total Requests: 2
   â”œâ”€â–º Successful: 2
   â”œâ”€â–º Failed: 0
   â”œâ”€â–º Total Cost: $0.000234
   â””â”€â–º Average Cost: $0.000117
```

### Evaluation Process:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Start       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Health Check    â”‚â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Send Request 1  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Extract Usage   â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Calculate Cost  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Send Request 2  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Extract Usage   â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Calculate Cost  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Save Results    â”‚  â”‚
â”‚ (JSON file)     â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â”‚             â”‚
       â–¼             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ Print Summary   â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
```

---

## ğŸ“Š Flow 3: Logging vÃ  PhÃ¢n TÃ­ch Chi PhÃ­

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LOGGING & COST ANALYSIS FLOW                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. LOGGING SOURCES
   â”‚
   â”œâ”€â–º Docker Logs (json-file driver)
   â”‚   â”œâ”€â–º Max size: 10MB
   â”‚   â”œâ”€â–º Max files: 5
   â”‚   â””â”€â–º Rotation: Automatic
   â”‚
   â”œâ”€â–º Nginx Access Logs (náº¿u dÃ¹ng nginx)
   â”‚   â”œâ”€â–º Request details
   â”‚   â”œâ”€â–º Response time
   â”‚   â””â”€â–º Upstream time
   â”‚
   â””â”€â–º Results File (gateway_results.json)
       â”œâ”€â–º Request/Response data
       â”œâ”€â–º Token usage
       â””â”€â–º Costs
        â”‚
        â–¼
2. COST ANALYSIS
   â”‚
   â”œâ”€â–º python3 analyze_costs.py --response-file gateway_results.json
   â”‚   â”‚
   â”‚   â”œâ”€â–º Parse JSON file
   â”‚   â”œâ”€â–º Extract usage data
   â”‚   â”œâ”€â–º Calculate costs (per model)
   â”‚   â””â”€â–º Generate statistics
   â”‚
   â””â”€â–º Output:
       â”œâ”€â–º Total Requests
       â”œâ”€â–º Successful vs Failed
       â”œâ”€â–º Total Tokens (prompt + completion)
       â”œâ”€â–º Total Cost
       â”œâ”€â–º Average Cost per Request
       â””â”€â–º Per-request Breakdown (náº¿u <= 20)
```

### Cost Analysis Process:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input Sources   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Docker â”‚ â”‚ Results File â”‚
â”‚ Logs   â”‚ â”‚ (JSON)        â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚            â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Parse Data  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Extract     â”‚
    â”‚ Usage Info  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Calculate   â”‚
    â”‚ Costs       â”‚
    â”‚ (per model) â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Generate    â”‚
    â”‚ Statistics  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Display     â”‚
    â”‚ Results     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cost Calculation Formula:

```
For each request:
  Input Cost = (prompt_tokens / 1000) Ã— model.input_price
  Output Cost = (completion_tokens / 1000) Ã— model.output_price
  Total Cost = Input Cost + Output Cost

Total Cost = Sum of all request costs
Average Cost = Total Cost / Number of successful requests
```

---

## ğŸ”„ INTEGRATED FLOW (Táº¥t cáº£ 3 yÃªu cáº§u)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   START         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 1. DEPLOY       â”‚
                    â”‚ docker compose  â”‚
                    â”‚     up -d       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 2. EVALUATE     â”‚
                    â”‚ evaluate_gateway â”‚
                    â”‚     .py         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 3. ANALYZE      â”‚
                    â”‚ analyze_costs   â”‚
                    â”‚     .py         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 4. SCALE        â”‚
                    â”‚ (Production)    â”‚
                    â”‚ --scale 3       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 5. MONITOR      â”‚
                    â”‚ Logs & Costs    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Data Flow

```
Client Request
    â”‚
    â–¼
Nginx Load Balancer
    â”‚
    â”œâ”€â–º Gateway Instance 1 â”€â”€â”
    â”œâ”€â–º Gateway Instance 2 â”€â”€â”¼â”€â–º OpenAI API
    â””â”€â–º Gateway Instance 3 â”€â”€â”˜
    â”‚
    â–¼
Response with Usage
    â”‚
    â”œâ”€â–º Client
    â”œâ”€â–º Docker Logs
    â”œâ”€â–º Results File (JSON)
    â””â”€â–º Cost Analysis
```

---

## ğŸ¯ Key Metrics Tracked

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         METRICS TRACKED             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  Deployment:                        â”‚
â”‚  â”œâ”€â–º Container status               â”‚
â”‚  â”œâ”€â–º Health checks                  â”‚
â”‚  â”œâ”€â–º Resource usage (CPU/Memory)    â”‚
â”‚  â””â”€â–º Instance count                 â”‚
â”‚                                     â”‚
â”‚  Evaluation:                        â”‚
â”‚  â”œâ”€â–º Request count                  â”‚
â”‚  â”œâ”€â–º Success rate                   â”‚
â”‚  â”œâ”€â–º Response time                  â”‚
â”‚  â””â”€â–º Error rate                     â”‚
â”‚                                     â”‚
â”‚  Costs:                             â”‚
â”‚  â”œâ”€â–º Total tokens                   â”‚
â”‚  â”œâ”€â–º Prompt tokens                  â”‚
â”‚  â”œâ”€â–º Completion tokens              â”‚
â”‚  â”œâ”€â–º Total cost                     â”‚
â”‚  â””â”€â–º Average cost per request       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

