upstream mlflow_gateway {
    # Docker Compose sẽ tự động resolve tên service
    # Với scale, sẽ có nhiều instances: gateway-mlflow-gateway-1, gateway-mlflow-gateway-2, etc.
    server mlflow-gateway:5000;
    # Nếu scale, thêm các instances khác
    # server gateway-mlflow-gateway-2:5000;
    # server gateway-mlflow-gateway-3:5000;
}

server {
    listen 80;
    server_name _;

    # Health check endpoint
    location /health {
        proxy_pass http://mlflow_gateway/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API endpoint
    location / {
        proxy_pass http://mlflow_gateway;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

